generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model CC {
  ccId           String        @id @map("cc_id")
  userId         String?       @unique @map("user_id")
  memberName     String?       @map("member_name")
  hotCredential  String?       @map("hot_credential")
  coldCredential String?       @map("cold_credential")
  status         String?
  createdAt      DateTime?     @default(now()) @map("created_at")
  updatedAt      DateTime?     @map("updated_at")
  user           User?         @relation(fields: [userId], references: [id])
  onchainVotes   OnchainVote[]

  @@map("cc")
}

model CrowdfundingCampaign {
  id              Int           @id @default(autoincrement())
  proposalDraftId Int           @unique @map("proposal_draft_id")
  createdAt       DateTime?     @default(now()) @map("created_at")
  updatedAt       DateTime?     @map("updated_at")
  proposalDraft   ProposalDraft @relation(fields: [proposalDraftId], references: [id])

  @@map("crowdfunding_campaign")
}

model Drep {
  drepId       String        @id @map("drep_id")
  userId       String?       @unique @map("user_id")
  name         String?
  paymentAddr  String?       @map("payment_addr")
  iconUrl      String?       @map("icon_url")
  doNotList    Boolean?      @map("do_not_list")
  votingPower  BigInt        @map("voting_power")
  createdAt    DateTime?     @default(now()) @map("created_at")
  updatedAt    DateTime?     @map("updated_at")
  user         User?         @relation(fields: [userId], references: [id])
  onchainVotes OnchainVote[]

  @@map("drep")
}

// Sync Status - Tracks sync job execution and provides distributed locking
// Critical for GCP Cloud Run/Cloud Scheduler deployments to prevent concurrent job execution
model SyncStatus {
  jobName        String    @id @map("job_name") // "proposal-sync", "voter-power-sync"
  displayName    String?   @map("display_name") // "Proposal Sync", "Voter Power Sync"
  isRunning      Boolean   @default(false) @map("is_running")
  startedAt      DateTime? @map("started_at")
  completedAt    DateTime? @map("completed_at")
  lastResult     String?   @map("last_result") // "success", "failed", "skipped"
  errorMessage   String?   @map("error_message") // Store error message if failed
  itemsProcessed Int?      @map("items_processed") // How many items were synced
  lockedBy       String?   @map("locked_by") // Container/instance ID
  expiresAt      DateTime? @map("expires_at") // Auto-unlock if crashed
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")

  @@map("sync_status")
}

// Net Change Limit (NCL) tracking for treasury withdrawals
model NCL {
  id        String   @id
  year      Int      @unique
  epoch     Int
  current   BigInt   @default(0)
  limit     BigInt
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @map("updated_at")

  @@map("ncl")
}

// Committee State - Caches eligible CC member count from Koios
model CommitteeState {
  id                String   @id @default("current")
  epoch             Int      // Epoch when last synced
  totalMembers      Int      @map("total_members")
  eligibleMembers   Int      @map("eligible_members")
  quorumNumerator   Int      @map("quorum_numerator")
  quorumDenominator Int      @map("quorum_denominator")
  isCommitteeValid  Boolean  @map("is_committee_valid")
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  @@map("committee_state")
}

model OnchainVote {
  id          String    @id
  txHash      String    @map("tx_hash")
  proposalId  String    @map("proposal_id")
  vote        VoteType?
  voterType   VoterType @map("voter_type")
  votingPower BigInt?   @map("voting_power")
  anchorUrl   String?   @map("anchor_url")
  anchorHash  String?   @map("anchor_hash")
  rationale   String?
  votedAt     DateTime? @default(now()) @map("voted_at")
  createdAt   DateTime? @default(now()) @map("created_at")
  updatedAt   DateTime? @map("updated_at")
  drepId      String?   @map("drep_id")
  spoId       String?   @map("spo_id")
  ccId        String?   @map("cc_id")

  cc       CC?      @relation(fields: [ccId], references: [ccId])
  drep     Drep?    @relation(fields: [drepId], references: [drepId])
  proposal Proposal @relation(fields: [proposalId], references: [proposalId])
  spo      SPO?     @relation(fields: [spoId], references: [poolId])

  @@unique([txHash, proposalId, voterType, drepId, spoId, ccId])
  @@map("onchain_vote")
}

model Proposal {
  id                          Int              @id @default(autoincrement())
  proposalId                  String           @unique @map("proposal_id")
  txHash                      String           @map("tx_hash")
  certIndex                   String           @map("cert_index")
  title                       String
  description                 String?
  rationale                   String?
  governanceActionType        GovernanceType?  @map("governance_action_type")
  status                      ProposalStatus   @default(ACTIVE)
  submissionEpoch             Int?             @map("submission_epoch")
  ratifiedEpoch               Int?             @map("ratified_epoch")
  enactedEpoch                Int?             @map("enacted_epoch")
  droppedEpoch                Int?             @map("dropped_epoch")
  expiredEpoch                Int?             @map("expired_epoch")
  expirationEpoch             Int?             @map("expiration_epoch")
  drepTotalVotePower          BigInt?          @map("drep_total_vote_power")
  drepActiveYesVotePower      BigInt?          @map("drep_active_yes_vote_power")
  drepActiveNoVotePower       BigInt?          @map("drep_active_no_vote_power")
  drepActiveAbstainVotePower  BigInt?          @map("drep_active_abstain_vote_power")
  drepAlwaysAbstainVotePower  BigInt?          @map("drep_always_abstain_vote_power")
  drepAlwaysNoConfidencePower BigInt?          @map("drep_always_no_confidence_power")
  drepInactiveVotePower       BigInt?          @map("drep_inactive_vote_power")
  spoTotalVotePower           BigInt?          @map("spo_total_vote_power")
  spoActiveYesVotePower       BigInt?          @map("spo_active_yes_vote_power")
  spoActiveNoVotePower        BigInt?          @map("spo_active_no_vote_power")
  spoActiveAbstainVotePower   BigInt?          @map("spo_active_abstain_vote_power")
  spoAlwaysAbstainVotePower   BigInt?          @map("spo_always_abstain_vote_power")
  spoAlwaysNoConfidencePower  BigInt?          @map("spo_always_no_confidence_power")
  metadata                    String?
  createdAt                   DateTime?        @default(now()) @map("created_at")
  updatedAt                   DateTime?        @map("updated_at")
  onchainVotes                OnchainVote[]

  @@unique([txHash, certIndex])
  @@map("proposal")
}

model ProposalDraft {
  id                   Int                   @id @default(autoincrement())
  governanceActionType GovernanceType        @map("governance_action_type")
  title                String
  abstract             String?
  motivation           String?
  rationale            String?
  comment              String?
  references           String?
  externalUpdates      String?               @map("external_updates")
  metadata             String?
  createdAt            DateTime?             @default(now()) @map("created_at")
  updatedAt            DateTime?             @map("updated_at")
  crowdfundingCampaign CrowdfundingCampaign?

  @@map("proposal_draft")
}

model SPO {
  poolId       String        @id @map("pool_id")
  userId       String?       @unique @map("user_id")
  poolName     String?       @map("pool_name")
  ticker       String?
  iconUrl      String?       @map("icon_url")
  votingPower  BigInt        @map("voting_power")
  createdAt    DateTime?     @default(now()) @map("created_at")
  updatedAt    DateTime?     @map("updated_at")
  onchainVotes OnchainVote[]
  user         User?         @relation(fields: [userId], references: [id])

  @@map("spo")
}

model User {
  id               String    @id
  walletAddress    String?   @map("wallet_address")
  stakeKeyLovelace Float?    @map("stake_key_lovelace")
  jwt              String?
  createdAt        DateTime? @default(now()) @map("created_at")
  updatedAt        DateTime? @map("updated_at")
  cc               CC?
  drep             Drep?
  spo              SPO?

  @@map("user")
}

enum GovernanceType {
  INFO_ACTION
  TREASURY_WITHDRAWALS
  NEW_CONSTITUTION
  HARD_FORK_INITIATION
  PROTOCOL_PARAMETER_CHANGE
  NO_CONFIDENCE
  UPDATE_COMMITTEE

  @@map("governance_type")
}

enum ProposalStatus {
  ACTIVE
  RATIFIED
  ENACTED
  EXPIRED
  CLOSED

  @@map("proposal_status")
}

enum VoteType {
  YES
  NO
  ABSTAIN

  @@map("vote_type")
}

enum VoterType {
  DREP
  SPO
  CC

  @@map("voter_type")
}
