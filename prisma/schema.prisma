// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Core types

model User {
  id               String    @id @default(uuid())
  // discordId        String    @unique
  walletAddress    String?
  stakeKeyLovelace Float?
  jwt              String?
  createdAt        DateTime? @default(now())
  updatedAt        DateTime? @updatedAt
  drep             Drep?
  spo              SPO?
  cc               CC?
  // spoDelegation    Boolean?
  // drepDelegation   Boolean?
  // offchainVotes          OffchainVote[]
}

model Drep {
  id           String        @id @default(uuid())
  drepId       String        @unique
  userId       String?       @unique
  stakeKey     String
  votingPower  Float
  createdAt    DateTime?     @default(now())
  updatedAt    DateTime?     @updatedAt
  user         User?         @relation(fields: [userId], references: [id])
  onchainVotes OnchainVote[]
}

model SPO {
  id           String        @id @default(uuid())
  poolId       String        @unique
  userId       String?       @unique
  poolName     String?
  ticker       String?
  votingPower  Float
  createdAt    DateTime?     @default(now())
  updatedAt    DateTime?     @updatedAt
  onchainVotes OnchainVote[]
  user         User?         @relation(fields: [userId], references: [id])
}

model CC {
  id             String        @id @default(uuid())
  ccId           String        @unique
  userId         String?       @unique
  memberName     String?
  hotCredential  String?
  coldCredential String?
  status         String?
  createdAt      DateTime?     @default(now())
  updatedAt      DateTime?     @updatedAt
  onchainVotes   OnchainVote[]
  user           User?         @relation(fields: [userId], references: [id])
}

enum VoteType {
  YES
  NO
  ABSTAIN
}

enum VoterType {
  DREP
  SPO
  CC
}

enum GovernanceType {
  INFO
  TREASURY
  CONSTITUTION
  HARD_FORK
  PROTOCOL_PARAMETER_CHANGE
  NO_CONFIDENCE
  UPDATE_COMMITTEE
}

enum ProposalStatus {
  ACTIVE
  RATIFIED
  EXPIRED
  APPROVED
  NOT_APPROVED
}

// Ingestion Types

model LastIngestedTime {
  id String @id @default(uuid())
}

// Viewer Types

model Proposal {
  id                   Int             @id @default(autoincrement())
  proposalId           String          @unique
  txHash               String
  certIndex            String
  title                String
  description          String?
  rationale            String?
  governanceActionType GovernanceType?
  status               ProposalStatus  @default(ACTIVE)
  submissionEpoch      Int?
  expiryEpoch          Int?
  metadata             String?
  createdAt            DateTime?       @default(now())
  updatedAt            DateTime?       @updatedAt
  onchainVotes         OnchainVote[]
  // offchainVotes   OffchainVote[]

  @@unique([txHash, certIndex])
}

model OnchainVote {
  id             String    @id @default(uuid())
  txHash         String
  proposal       Proposal  @relation(fields: [proposalId], references: [id])
  proposalId     Int
  vote           VoteType?
  voterType      VoterType
  votingPower    String?
  votingPowerAda Float?
  anchorUrl      String?
  anchorHash     String?
  votedAt        DateTime? @default(now())
  createdAt      DateTime? @default(now())
  updatedAt      DateTime? @updatedAt
  drep           Drep?     @relation(fields: [drepId], references: [id])
  drepId         String?
  spo            SPO?      @relation(fields: [spoId], references: [id])
  spoId          String?
  cc             CC?       @relation(fields: [ccId], references: [id])
  ccId           String?

  @@unique([proposalId, voterType, drepId, spoId, ccId])
}

// Crowdfunding Types

model CrowdfundingCampaign {
  id              Int @id @default(autoincrement())
  proposalDraftId Int @unique

  createdAt DateTime? @default(now())
  updatedAt DateTime? @updatedAt

  proposalDraft ProposalDraft @relation(fields: [proposalDraftId], references: [id])
}

model ProposalDraft {
  id                   Int                   @id @default(autoincrement())
  governanceActionType GovernanceType
  title                String
  abstract             String?
  motivation           String?
  rationale            String?
  comment              String?
  references           String?
  externalUpdates      String?
  metadata             String?
  createdAt            DateTime?             @default(now())
  updatedAt            DateTime?             @updatedAt
  crowdfundingCampaign CrowdfundingCampaign?
}

// Delegators Engagement Types - Ignore for now

// model OffchainVote {
//   proposal   Proposal  @relation(fields: [proposalId], references: [id])
//   proposalId Int
//   user       User      @relation(fields: [userId], references: [id])
//   userId     String
//   vote       VoteType?
//   createdAt  DateTime? @default(now())
//   updatedAt  DateTime? @updatedAt

//   @@id([proposalId, userId])
// }
